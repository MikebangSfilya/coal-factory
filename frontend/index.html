<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coal Factory</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --text: #ecf0f1;
            --dark-bg: #1a252f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--text);
        }

        .stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stat-card {
            background-color: var(--secondary);
            padding: 15px;
            border-radius: 6px;
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--warning);
        }

        .sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .section {
            background-color: var(--primary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: var(--text);
        }

        .miner-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .miner-item {
            background-color: var(--secondary);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }

        .miner-info {
            font-size: 0.9rem;
        }

        .miner-type {
            font-weight: bold;
        }

        .miner-energy {
            color: var(--warning);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        select, button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background-color: var(--secondary);
            color: var(--text);
            font-size: 1rem;
        }

        button {
            background-color: var(--accent);
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        button:hover:not(:disabled) {
            background-color: #c0392b;
        }

        button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }

        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .item-card {
            background-color: var(--secondary);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .item-card:hover {
            transform: translateY(-5px);
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .item-cost {
            color: var(--warning);
            margin-bottom: 10px;
        }

        .item-status {
            font-style: italic;
            margin-bottom: 10px;
        }

        .purchased {
            color: var(--success);
        }

        .not-purchased {
            color: var(--accent);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            min-width: 300px;
        }

        .success {
            background-color: var(--success);
        }

        .error {
            background-color: var(--accent);
        }

        .win-message {
            text-align: center;
            padding: 30px;
            background-color: var(--success);
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .win-stats {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        @media (max-width: 768px) {
            .sections {
                grid-template-columns: 1fr;
            }

            .stats {
                flex-direction: column;
            }

            .notification {
                min-width: 90%;
                right: 5%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>üè≠ –£–≥–æ–ª—å–Ω–∞—è –§–∞–±—Ä–∏–∫–∞</h1>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">–ë–∞–ª–∞–Ω—Å —É–≥–ª—è</div>
                <div class="stat-value" id="balance">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ú–∞–ª–µ–Ω—å–∫–∏–µ</div>
                <div class="stat-value" id="little-miners">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–û–±—ã—á–Ω—ã–µ</div>
                <div class="stat-value" id="normal-miners">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ú–æ—â–Ω—ã–µ</div>
                <div class="stat-value" id="powerful-miners">0</div>
            </div>
        </div>
    </header>

    <div class="sections">
        <div class="section">
            <h2>üë∑ –ù–∞–Ω—è—Ç—å —à–∞—Ö—Ç–µ—Ä–∞</h2>
            <div class="form-group">
                <label for="miner-type">–¢–∏–ø —à–∞—Ö—Ç–µ—Ä–∞:</label>
                <select id="miner-type">
                    <option value="little">–ú–∞–ª–µ–Ω—å–∫–∏–π (5 —É–≥–ª—è/—Å–µ–∫)</option>
                    <option value="normal">–û–±—ã—á–Ω—ã–π (50 —É–≥–ª—è/—Å–µ–∫)</option>
                    <option value="powerful">–ú–æ—â–Ω—ã–π (450 —É–≥–ª—è/—Å–µ–∫)</option>
                </select>
            </div>
            <button id="hire-btn">üöÄ –ù–∞–Ω—è—Ç—å</button>
        </div>

        <div class="section">
            <h2>üìã –ú–æ–∏ —à–∞—Ö—Ç–µ—Ä—ã</h2>
            <div class="miner-list" id="miners-list">
                <!-- –°–ø–∏—Å–æ–∫ —à–∞—Ö—Ç–µ—Ä–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            <button id="refresh-miners">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <div class="section">
            <h2>üõí –ú–∞–≥–∞–∑–∏–Ω –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h2>
            <div class="item-list" id="items-list">
                <!-- –°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üèÜ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–±–µ–¥—É</h2>
        <p>–ö—É–ø–∏—Ç–µ –≤—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: –ö–∏—Ä–∫–∞ (5k), –í–µ–Ω—Ç–∏–ª—è—Ü–∏—è (15k), –¢–µ–ª–µ–∂–∫–∞ (50k)</p>
        <button id="check-win">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–±–µ–¥—É</button>
    </div>

    <div class="win-message" id="win-message">
        <h2>üéâ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –í–´ –í–´–ò–ì–†–ê–õ–ò! üéâ</h2>
        <p>–í—ã —É–ª—É—á—à–∏–ª–∏ —É—Å–ª–æ–≤–∏—è —Ç—Ä—É–¥–∞ —à–∞—Ö—Ç–µ—Ä–æ–≤! –í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫—É–ø–ª–µ–Ω–æ!</p>
        <div class="win-stats" id="win-stats">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–±–µ–¥—ã –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script>
    const API_BASE = 'http://localhost:8080';

    const balanceEl = document.getElementById('balance');
    const littleMinersEl = document.getElementById('little-miners');
    const normalMinersEl = document.getElementById('normal-miners');
    const powerfulMinersEl = document.getElementById('powerful-miners');
    const minerTypeSelect = document.getElementById('miner-type');
    const hireBtn = document.getElementById('hire-btn');
    const minersListEl = document.getElementById('miners-list');
    const refreshMinersBtn = document.getElementById('refresh-miners');
    const itemsListEl = document.getElementById('items-list');
    const checkWinBtn = document.getElementById('check-win');
    const winMessageEl = document.getElementById('win-message');
    const winStatsEl = document.getElementById('win-stats');
    const notificationEl = document.getElementById('notification');

    let miners = [];
    let items = {
        pick: { isBuyed: false, cost: 5000 },
        vent: { isBuyed: false, cost: 15000 },
        trolley: { isBuyed: false, cost: 50000 }
    };
    let balance = 0;
    let littleMinersCount = 0;
    let normalMinersCount = 0;
    let powerfulMinersCount = 0;

    function showNotification(message, type = 'success') {
        notificationEl.textContent = message;
        notificationEl.className = `notification ${type}`;
        notificationEl.style.opacity = '1';
        setTimeout(() => { notificationEl.style.opacity = '0'; }, 4000);
    }

    async function handleApiError(response) {
        if (!response.ok) {
            let errorMessage = `HTTP ${response.status}`;
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
            } catch (e) {}
            throw new Error(errorMessage);
        }
        return response.json();
    }

    async function fetchBalance() {
        try {
            const response = await fetch(`${API_BASE}/balance`);
            const data = await handleApiError(response);
            balance = data;
            balanceEl.textContent = data.toLocaleString();
            renderItems();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∞:', error);
        }
    }

    async function hireMiner(minerType) {
        try {
            const response = await fetch(`${API_BASE}/miners`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ miner_type: minerType }),
            });
            await handleApiError(response);
            showNotification(`‚úÖ –®–∞—Ö—Ç–µ—Ä "${minerType}" –Ω–∞–Ω—è—Ç!`, 'success');
            await fetchBalance();
            await fetchMiners();
        } catch (error) {
            showNotification(`‚ùå ${error.message}`, 'error');
        }
    }

    async function fetchMiners() {
        try {
            const response = await fetch(`${API_BASE}/miners`);
            const data = await handleApiError(response);
            miners = Object.entries(data).map(([id, minerInfo]) => ({
                id, ...minerInfo
            }));
            renderMiners();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —à–∞—Ö—Ç–µ—Ä–æ–≤:', error);
        }
    }

    async function fetchItems() {
        try {
            const response = await fetch(`${API_BASE}/items`);
            const data = await handleApiError(response);

            items.pick.isBuyed = data.Pick?.IsBuyed ?? data.pick?.isBuyed ?? false;
            items.pick.cost    = data.Pick?.Cost    ?? data.pick?.cost    ?? 5000;
            items.vent.isBuyed = data.Vent?.IsBuyed ?? data.vent?.isBuyed ?? false;
            items.vent.cost    = data.Vent?.Cost    ?? data.vent?.cost    ?? 15000;
            items.trolley.isBuyed = data.Trolley?.IsBuyed ?? data.trolley?.isBuyed ?? false;
            items.trolley.cost    = data.Trolley?.Cost    ?? data.trolley?.cost    ?? 50000;

            renderItems();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
        }
    }

    async function buyItem(itemType) {
        try {
            const response = await fetch(`${API_BASE}/items/${itemType}`, {
                method: 'POST',
            });
            await handleApiError(response);
            showNotification(`‚úÖ –ö—É–ø–ª–µ–Ω–æ: ${itemType}!`, 'success');
            await fetchBalance();
            await fetchItems();
        } catch (error) {
            showNotification(`‚ùå ${error.message}`, 'error');
        }
    }

    async function checkWin() {
        try {
            const response = await fetch(`${API_BASE}/win`);
            const data = await handleApiError(response);

            winStatsEl.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">üí∞ –§–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
                        <div class="stat-value">${(data.Balance || data.balance || 0).toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚è±Ô∏è –í—Ä–µ–º—è –∏–≥—Ä—ã</div>
                        <div class="stat-value">${data.TotalTime || data.totalTime || 'N/A'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üë∑ –ú–∞–ª–µ–Ω—å–∫–∏–µ</div>
                        <div class="stat-value">${data.LittleMinersHired || data.littleMinersHired || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üë∑ –û–±—ã—á–Ω—ã–µ</div>
                        <div class="stat-value">${data.NormalMinersHired || data.normalMinersHired || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üë∑ –ú–æ—â–Ω—ã–µ</div>
                        <div class="stat-value">${data.PowerfulMinersHired || data.powerfulMinersHired || 0}</div>
                    </div>
                `;
            winMessageEl.style.display = 'block';
            showNotification('üèÜ –ü–û–ë–ï–î–ê!', 'success');
        } catch (error) {
            showNotification(`‚è≥ ${error.message}`, 'error');
        }
    }

    function renderMiners() {
        minersListEl.innerHTML = '';

        if (miners.length === 0) {
            minersListEl.innerHTML = '<p>üë∑ –ü–æ–∫–∞ –Ω–µ—Ç —à–∞—Ö—Ç–µ—Ä–æ–≤</p>';
            littleMinersCount = 0;
            normalMinersCount = 0;
            powerfulMinersCount = 0;
            littleMinersEl.textContent   = '0';
            normalMinersEl.textContent   = '0';
            powerfulMinersEl.textContent = '0';
            return;
        }

        // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Å—á—ë—Ç–æ–º
        littleMinersCount = 0;
        normalMinersCount = 0;
        powerfulMinersCount = 0;

        minersListEl.innerHTML = miners.map(miner => {
            const type   = miner.minerType || miner.MinerType || 'unknown';
            const energy = miner.energy    || miner.Energy    || 0;
            const power  = miner.coalPower || miner.CoalPower || 0;

            if (type === 'little')      littleMinersCount++;
            else if (type === 'normal') normalMinersCount++;
            else if (type === 'powerful') powerfulMinersCount++;

            return `
                    <div class="miner-item">
                        <div>
                            <div class="miner-type">${type}</div>
                            <div class="miner-info">ID: ${miner.id || miner.ID}</div>
                        </div>
                        <div>
                            <div class="miner-energy">‚ö° ${energy}</div>
                            <div>üíé ${power}</div>
                        </div>
                    </div>
                `;
        }).join('');

        littleMinersEl.textContent   = littleMinersCount;
        normalMinersEl.textContent   = normalMinersCount;
        powerfulMinersEl.textContent = powerfulMinersCount;
    }

    function renderItems() {
        if (balance === undefined) return;

        itemsListEl.innerHTML = '';
        const itemTypes = [
            { type: 'pick',    name: '‚õèÔ∏è –ö–∏—Ä–∫–∞',       data: items.pick },
            { type: 'vent',    name: 'üí® –í–µ–Ω—Ç–∏–ª—è—Ü–∏—è',  data: items.vent },
            { type: 'trolley', name: 'üöú –¢–µ–ª–µ–∂–∫–∞',     data: items.trolley }
        ];

        itemTypes.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'item-card';
            const isPurchased = item.data.isBuyed;
            const canAfford   = balance >= item.data.cost;

            itemEl.innerHTML = `
                    <div class="item-name">${item.name}</div>
                    <div class="item-cost">üí∞ ${item.data.cost.toLocaleString()}</div>
                    <div class="item-status ${isPurchased ? 'purchased' : 'not-purchased'}">
                        ${isPurchased ? '‚úì –ö—É–ø–ª–µ–Ω–æ' : '‚úó –î–æ—Å—Ç—É–ø–Ω–æ'}
                    </div>
                    <button class="buy-item-btn" data-type="${item.type}"
                            ${isPurchased || !canAfford ? 'disabled' : ''}>
                        ${isPurchased ? '‚úÖ –ö—É–ø–ª–µ–Ω–æ' : `–ö—É–ø–∏—Ç—å (-${item.data.cost.toLocaleString()})`}
                    </button>
                `;
            itemsListEl.appendChild(itemEl);
        });
    }

    function init() {
        Promise.all([fetchBalance(), fetchMiners(), fetchItems()]);

        setInterval(() => {
            fetchBalance();
            fetchMiners();
        }, 3000);

        document.addEventListener('click', async (e) => {
            if (e.target.matches('#hire-btn:not([disabled])')) {
                const minerType = minerTypeSelect.value;
                hireBtn.disabled = true;
                setTimeout(() => hireBtn.disabled = false, 1000);
                await hireMiner(minerType);
            }
            if (e.target.matches('.buy-item-btn:not([disabled])')) {
                const itemType = e.target.dataset.type;
                await buyItem(itemType);
            }
            if (e.target.matches('#refresh-miners')) {
                await fetchMiners();
            }
            if (e.target.matches('#check-win')) {
                await checkWin();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
